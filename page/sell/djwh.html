<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
    <meta name="keywords" content="">
    <link rel="stylesheet" href="../../assets/layui/css/layui.css">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <title>销售单价维护</title>
    <style>
        .layui-layer-dialog .layui-layer-content{
            padding-right:6px !important;
        }
    </style>
</head>
<body>
    <div class="hcbox layui-form">
        <div class="hclit">
            <p class="hctitle">销售单价维护</p>
            <!-- <ul class="jlul layui-form clearfix">
                <li class="">
                    <div class="inlists">
                        <p class="dd-name">客户</p>
                        <div class="dd-value">
                            <input type="text" autocomplete="off" name="kh_num" readonly="" value="">
                        </div>
                    </div>
                </li>
                <li class="">
                    <div class="inlists">
                        <p class="dd-name">强度等级</p>
                        <div class="dd-value">
                            <select name="strong_lv" id="strong_lv">
                    			
                            </select>
                        </div>
                    </div>
                </li>
                <li class="">
                    <div class="inlists">
                        <p class="dd-name">品种</p>
                        <div class="dd-value">
                            <select name="pinzhong" id="pinzhong">
                    			
                            </select>
                        </div>
                    </div>
                </li>
                <li class="">
                    <div class="inlists">
                        <p class="dd-name">单价</p>
                        <div class="dd-value">
                            <input type="number" autocomplete="off" name="unit_price" value="">
                        </div>
                    </div>
                </li>
                <li class="">
                    <div class="inlists">
                        <p class="dd-name">客户类型</p>
                        <div class="dd-value">
                            <select class="form-control input-sm" name="balance_type" id="opp">
                                <option value="合同">合同</option>
                                <option value="预付款">预付款</option>
                            </select>
                        </div>
                    </div>
                </li>
                <li class="">
                    <div class="dd-value task-btnbox hcbig clearfix">
                        <div class="layui-inline" style="float:left">
                            <button class="hcbtn save">保存</button> 
                        </div>
                    </div>
                </li>
            </ul> -->
        </div>
        <div style="margin-bottom:30px;padding-right:24px">
            <div class="layui-inline hcbig clearfix">
                <label class="layui-form-label">搜索类型：</label>
                <div class="layui-input-inline">
                    <select name="search_key" lay-filter="search_key">
	                    <option value="">选择搜索类型</option>
	                    <option value="kh_num">客户编号</option>
	                    <option value="kh_name">客户名称</option>
	                    <option value="sdf_num">送达方编号</option>
	                    <option value="proj_name">工程名称</option>
	                    <option value="strong_lv">强度等级</option>
	                    <option value="pinzhong">品种</option>
	                    <option value="business_man">业务员</option>
	                </select>
                </div>
                <div class="layui-input-inline">
					<input type="text" id="search_val" autocomplete="off" class="layui-input bigInput">
                </div>
            </div>
            <div class="layui-inline hcbig clearfix">
                <div class="layui-inline" style="float:left">
                    <button class="hcbtn search">查询</button>
                </div>
                
            </div>
            <div class="layui-inline" style="float:right">
               <button class="hcbtn add">添加</button> 
            </div>
        </div>
        <div class="tablebb" style="padding-right:24px">
            <table class="layui-hide" id="ddtest" lay-filter="ddtest"></table>
        </div>
    </div>
    <script type="text/html" id="barDemo">
        <a lay-event="edit" style="">编辑</a>
        <a lay-event="del" style="">删除</a>
    </script>
    <script type="text/html" id="layeropen">
        <ul class="jlul layui-form clearfix">
            <input type="hidden" name="sp_id">
            <input type="hidden" name="kh_name">
            <input type="hidden" name="proj_name">
            <input type="hidden" name="business_man">
            <input type="hidden" name="kh_num">
            <input type="hidden" name="sdf_num">
            <li class="double">
                <div class="inlists">
                    <p class="dd-name">客户</p>
                    <div class="dd-value">
                        <input type="text" id="kh_num" name="" readonly="" value="">
                    </div>
                </div>
            </li>
            <li class="">
                <div class="inlists">
                    <p class="dd-name">强度等级</p>
                    <div class="dd-value">
                        <select name="strong_lv" id="strong_lv">
                            
                        </select>
                    </div>
                </div>
            </li>
            <li class="">
                <div class="inlists">
                    <p class="dd-name">品种</p>
                    <div class="dd-value">
                        <select name="pinzhong" id="pinzhong">
                            
                        </select>
                    </div>
                </div>
            </li>
            <li class="">
                <div class="inlists">
                    <p class="dd-name">单价</p>
                    <div class="dd-value">
                        <input type="number" autocomplete="off" name="unit_price" value="">
                    </div>
                </div>
            </li>
            <li class="">
                <div class="inlists">
                    <p class="dd-name">客户类型</p>
                    <div class="dd-value">
                        <select class="form-control input-sm" name="balance_type" id="opp">
                            <option value="合同">合同</option>
                            <option value="预付款">预付款</option>
                        </select>
                    </div>
                </div>
            </li>
        </ul>
    </script>
    <script src="../../assets/layui/layui.all.js"></script>
    <script src="../../assets/jquery/jquery.min.js"></script>
    <script src="../../assets/js/echarts.js"></script>
    <script src="../../assets/js/bluebirds.js"></script>
    <script src="../../assets/js/common.js"></script>
    <script>
		var table = layui.table;
        var form = layui.form;
        var laytpl = layui.laytpl;
        var laydate = layui.laydate;
  
        // // 点击保存
        // $('body').on('click','.save',function(){
        //     var data = formData();
        //     console.log(data);
        // });

        // 点击选择客户
        var indexs = 0;
        $('body').on('click','#kh_num',function(){
            indexs = layer.open({
                type:2,
                title:'客户信息',
                area:['900px','700px'],
                content: './djwh-client.html'
            })
        });

        // 
        $('.add').click(function(){
            layer.open({
                title:'添加',
                area:['615px','500px'],
                content: $('#layeropen').html(),
                success (layero,index) {
                    selectRender();
                    form.render()
                },
                yes (index, layero) {
                    var url = '/hcms/sale_price/add_price';
                    var data = formData();
                    console.log(data)
                    if (!data.kh_num) {
                        alert('请选择客户编码');
                        return false
                    }
                    if (!data.unit_price) {
                        alert('请输入单价');
                        return false
                    }
                    if (!data.balance_type) {
                        alert('请选择客户类型');
                        return false
                    }
                    if (!data.strong_lv) {
                        alert('请选择强度等级');
                        return false
                    }
                    promiseSovl(url, 'post', data).then(function(res){
                        if(res.code == 0) {
                            layer.msg('保存成功', {time:2000},function(){
                                location.reload()
                                layer.close(index)
                            })
                        }else {
                            layer.msg(res.msg, { time:2000 })
                        }
                    })
                }
            })
        });

        // 窗口大小改变事件
        window.onresize = function() {
        	listReisze()
        }
		listReisze()
		$('.search').click(function(){
			var key = $('#search_val').attr('name')
			var value = $('#search_val').val();
			var obj = new Object();
			obj[key] = value;
			tableIns.reload({
				where:obj,
				page:{
					curr:1
				}
			})
		})
		form.on('select(search_key)',function(obj){
			$(obj.elem).parent().next().find('input').attr('name',obj.value)
		})


	    var tableIns = tableRender({
	        elem: '#ddtest',
	        // url: '../assets/api/djwhData.json',
            url:  baseUrl + '/hcms/sale/sale_price',
	        cols: [[
				{field: 'id', title: '序号', width: 80, sort: true, fixed: 'left'},
                {field: 'kh_num', title: '客户编号', width: 120, sort: true,fixed: 'left'},
                {field: 'kh_name', title: '客户名称', width: 260},
                {field: 'sdf_num', title: '送达方编号',sort: true, width: 130},
                {field: 'proj_name', title: '工程名称', width: 260},
                {field: 'strong_lv', title: '强度等级', width: 100},
                {field: 'pinzhong', title: '品种', width: 70},
                {field: 'balance_type', title: '客户类型', width: 100},
                {field: 'unit_price', title: '单价', width: 90},
                {field: 'business_man', title: '业务经办', width: 100},
                {field: 'create_time', title: '添加时间', width: 170},
                {title: '操作', width:120, toolbar:'#barDemo',fixed:"right",align:"center"}
            ]],
	        even: true,
	        page: true,
	        skin:'row',
	        done: function() {
	            
	        }
	    });

	    // 表格数据编辑
	    table.on('tool(ddtest)', function(obj) {
	    	var id = obj.data.id
	        if (obj.event == 'edit') {
	            //编辑
	            
                layer.open({
                    title:'编辑',
                    area:['615px','500px'],
                    content: $('#layeropen').html(),
                    success (layero,index) {
                        selectRender(obj.data.strong_lv, obj.data.pinzhong);
                        dataRender(obj.data)
                        $('[name=sp_id]').val(obj.data.id)
                        var values = '客户编号：' + obj.data.kh_num + ' -- 送达方编码：' + obj.data.sdf_num;
                        $('#kh_num').val(values);
                        form.render()
                    },
                    yes (index, layero) {
                        var url = '/hcms/sale_price/edit_price';
                        var data = formData();
                        console.log(data)
                        if (!data.kh_num) {
                            alert('请选择客户编码');
                            return false
                        }
                        if (!data.unit_price) {
                            alert('请输入单价');
                            return false
                        }
                        if (!data.balance_type) {
                            alert('请选择客户类型');
                            return false
                        }
                        if (!data.strong_lv) {
                            alert('请选择强度等级');
                            return false
                        }
                        promiseSovl(url, 'post', data).then(function(res){
                            if(res.code == 0) {
                                layer.msg('保存成功', {time:2000},function(){
                                    location.reload();
                                    layer.close(index)
                                })
                            }else {
                                layer.msg(res.msg, { time:2000 })
                            }
                        })
                    }
                })
	        } else if(obj.event == 'del') {
	        	var index = layer.confirm('确定要删除吗？',function(){
                    var url = '/hcms/sale_price/del_price';
                    var data = {
                        sp_id: obj.data.id
                    }
                    promiseSovl(url, 'get', data).then(function(res){
                        if(res.code == 0) {
                            layer.msg('删除成功', {time:2000}, function(){
                                location.reload()
                            })
                        } else {
                            alert(res.msg)
                        }
                    })
	        		
	        	})
	        }
	    });
        function selectRender(strong_lv, pinzhong){
            var surl = '/hcms/sale_price/base_data'
            promiseSovl(surl).then(function(res){
                if(res.code == 0) {
                    var len = res.data.strong_lvs.length;
                    var option = '<option value="">请选择</option>';
                    for(var i = 0;i < len;i++){
                        if(res.data.strong_lvs[i] == strong_lv)
                            option += '<option value="'+ res.data.strong_lvs[i] +'" selected="">'+ res.data.strong_lvs[i] +'</option>'
                        else
                            option += '<option value="'+ res.data.strong_lvs[i] +'">'+ res.data.strong_lvs[i] +'</option>'
                    }
                    $('#strong_lv').html(option)
                    var len2 = res.data.pinzhongs.length;
                    var option2 = '<option value="">请选择</option>';
                    for(var i = 0;i < len2;i++){
                        if(res.data.pinzhongs[i] == pinzhong)
                            option2 += '<option value="'+ res.data.pinzhongs[i] +'" selected="">'+ res.data.pinzhongs[i] +'</option>'
                        else
                            option2 += '<option value="'+ res.data.pinzhongs[i] +'">'+ res.data.pinzhongs[i] +'</option>'
                    }
                    $('#pinzhong').html(option2)
                    form.render('select')
                }
            })
        }
	</script>
</body>
</html>